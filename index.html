<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAdmC - 6º BBM | CBMRS</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
/* --- TODO SEU CSS EXISTENTE AQUI --- */
:root { --azul-escuro: #001D3D; --azul-medio: #003566; --laranja-cbm: #FF9E3D; --vermelho-cbm: #C40000; --azul-texto: #002B5B; --cinza-fundo: #F4F6F9; }
* { box-sizing: border-box; transition: all 0.2s ease; }
html { scroll-behavior: smooth; }
body { margin: 0; font-family: 'Open Sans', sans-serif; background: var(--azul-escuro); display: flex; flex-direction: column; min-height: 100vh; }
/* ... resto do seu CSS permanece igual ... */
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div><p style="font-weight: 800; margin-top: 20px; letter-spacing: 2px;">AUTENTICANDO MILITAR...</p></div>
<div id="erroSenha">USUÁRIO OU SENHA INCORRETOS!</div>
<button id="btnTopo" onclick="voltarAoTopo()"><i class="fas fa-chevron-up"></i></button>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-left">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Brasao_cbmrs.png" alt="CBMRS">
            <h1>CBMRS</h1>
            <div class="sub-titulo-logo">Corpo de Bombeiros Militar</div>
            <p>6º Batalhão de Bombeiro Militar</p>
        </div>
        <form class="login-right" onsubmit="event.preventDefault(); acaoLogin();">
            <h2>SAdmC - Acesso</h2>
            <div class="sub-sigla">Seção Administrativa e Correição</div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="inputEmail" placeholder="Digite seu email" required>
            </div>
            <div class="form-group">
                <label>Senha de Acesso</label>
                <input type="password" id="inputSenha" placeholder="Digite sua senha" required>
                <i class="fas fa-eye toggle-password" onclick="togglePassword()"></i>
            </div>
            <button type="submit" class="btn-acesso">Entrar no Sistema</button>
        </form>
    </div>
</div>

<!-- SISTEMA -->
<div id="sistema">
    <div class="header-top">CORPO DE BOMBEIROS MILITAR DO ESTADO DO RIO GRANDE DO SUL</div>
    <div class="header-stripe"></div>
    <div class="dashboard-container">
        <div class="militar-bar">
            <div>
                <div style="font-size: 12px; color: #999; font-weight: 800; text-transform: uppercase;">Bem-vindo,</div>
                <div class="militar-status">Militar: <span id="labelNome"></span></div>
            </div>
            <div id="txtDataHora" class="txt-data-hora"></div>
            <button onclick="logout()" style="background:var(--azul-medio); color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:800; cursor:pointer;">SAIR</button>
        </div>

        <div id="painelAdmin">
            <h3><i class="fas fa-user-cog"></i> Gerenciamento de Acessos</h3>
            <div style="display:flex; gap:10px; flex-wrap: wrap; margin-bottom: 20px;">
                <input type="text" id="admNome" placeholder="UID do Militar" style="padding:12px; flex:2; border-radius:5px; border:1px solid #ccc;">
                <input type="password" id="admSenha" placeholder="Senha" style="padding:12px; flex:1; border-radius:5px; border:1px solid #ccc;">
                <select id="admNivel" style="padding:12px; flex:1; border-radius:5px; border:1px solid #ccc;">
                    <option value="PUBLICO">Apenas Acervo</option>
                    <option value="B1">B1 - RH</option>
                    <option value="B2">B2 - Inteligência</option>
                    <option value="B3">B3 - Operações</option>
                    <option value="B4">B4 - Logística</option>
                    <option value="SCOR">SCor - Correição</option>
                    <option value="CHEFE">Chefe (Ver Tudo)</option>
                    <option value="MASTER">Desenvolvedor</option>
                </select>
                <button onclick="addMilitar()" style="background:#27ae60; color:white; border:none; padding:12px 25px; cursor:pointer; font-weight:800; border-radius:5px;">CADASTRAR</button>
            </div>
            <div class="admin-table-wrapper">
                <table class="admin-table">
                    <thead><tr><th>UID / Nome</th><th>Nível</th><th>Ações</th></tr></thead>
                    <tbody id="tabelaUsuarios"></tbody>
                </table>
            </div>
        </div>

        <!-- SUAS SEÇÕES (ACERVO, B1, B2...) PERMANECEM IGUAIS -->
        <!-- ... todo o HTML do dashboard que você já tinha ... -->
    </div>
</div>

<footer class="footer-full">
    <!-- SEU RODAPÉ PERMANECE IGUAL -->
</footer>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDfHrIaQzylbPaPBH_rAlew1CoINTfIySE",
    authDomain: "sadmc-6bbm.firebaseapp.com",
    databaseURL: "https://sadmc-6bbm-4411d-default-rtdb.firebaseio.com/",
    projectId: "sadmc-6bbm",
    storageBucket: "sadmc-6bbm.firebasestorage.app",
    messagingSenderId: "949715183102",
    appId: "1:949715183102:web:7c0f2c0153beb6c1fa8caf"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// LOGIN COM FIREBASE AUTH E NÓ MILITARES
function acaoLogin() {
    const email = document.getElementById("inputEmail").value;
    const senha = document.getElementById("inputSenha").value;
    document.getElementById("loadingOverlay").style.display = "flex";

    auth.signInWithEmailAndPassword(email, senha)
    .then(userCredential => {
        const uid = userCredential.user.uid;
        db.ref('militares/' + uid).once('value').then(snapshot => {
            const dados = snapshot.val();
            if(!dados) {
                alert("Usuário sem nível cadastrado!");
                auth.signOut();
                document.getElementById("loadingOverlay").style.display = "none";
                return;
            }
            mostrarSecao(uid, dados);
        });
    })
    .catch(error => {
        document.getElementById("erroSenha").style.display = "block";
        setTimeout(() => document.getElementById("erroSenha").style.display = "none", 3000);
        document.getElementById("loadingOverlay").style.display = "none";
    });
}

function mostrarSecao(uid, dados) {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("sistema").style.display = "block";
    document.getElementById("labelNome").innerText = uid;

    const nivel = dados.nivel;
    document.querySelectorAll(".secao-container").forEach(x => x.style.display = "none");
    if(nivel === "MASTER" || nivel === "CHEFE") {
        document.querySelectorAll(".secao-container").forEach(x => x.style.display = "block");
        if(nivel === "MASTER") document.getElementById("painelAdmin").style.display = "block";
    } else {
        document.getElementById("secao-ACERVO").style.display = "block";
        const alvo = document.getElementById("secao-" + nivel);
        if(alvo) alvo.style.display = "block";
    }
}

// LOGOUT
function logout() {
    auth.signOut();
    location.reload();
}

// ADMIN: CADASTRAR NOVO USUÁRIO
function addMilitar() {
    const uid = document.getElementById("admNome").value.trim();
    const nivel = document.getElementById("admNivel").value;
    const senha = document.getElementById("admSenha").value;

    if(uid && nivel && senha) {
        // Cria usuário no Firebase Auth
        auth.createUserWithEmailAndPassword(uid + "@cbmrs.local", senha)
        .then(userCred => {
            db.ref('militares/' + userCred.user.uid).set({ nivel: nivel });
            renderUsuarios();
            alert("Usuário cadastrado!");
        })
        .catch(err => alert("Erro ao cadastrar: " + err.message));
    }
}

// RENDERIZA TABELA DE USUÁRIOS
function renderUsuarios() {
    db.ref('militares').once('value').then(snapshot => {
        const dados = snapshot.val() || {};
        const tabela = document.getElementById("tabelaUsuarios");
        tabela.innerHTML = "";
        for(let uid in dados) {
            let row = tabela.insertRow();
            row.innerHTML = `<td>${uid}</td><td>${dados[uid].nivel}</td>
            <td style="text-align:center;"><button onclick="deletarMilitar('${uid}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>`;
        }
    });
}

// DELETAR USUÁRIO
function deletarMilitar(uid) {
    if(confirm(`Remover ${uid}?`)) db.ref('militares/' + uid).remove().then(renderUsuarios);
}

// TOGGLE PASSWORD
function togglePassword() {
    const i = document.getElementById("inputSenha");
    i.type = i.type === "password" ? "text" : "password";
}

// RELÓGIO
function clock() {
    const d = new Date();
    document.getElementById('txtDataHora').innerHTML = d.toLocaleDateString('pt-BR', {day:'numeric', month:'long'}) + "<br>" + d.toLocaleTimeString('pt-BR');
}
setInterval(clock, 1000);
window.onscroll = function() { document.getElementById("btnTopo").style.display = window.scrollY > 300 ? "block" : "none"; };
function voltarAoTopo() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

// INICIALIZA TABELA DE USUÁRIOS
renderUsuarios();
</script>
</body>
</html>
